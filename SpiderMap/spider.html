<!DOCTYPE html>
<html xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">
	<head>
		<title>A Hop, Skip and a Jump</title>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
		<link rel="stylesheet" href="map.css">
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
		<script type="text/javascript" src="toronto.js"></script>
		<script type="text/javascript" src="matrix.js"></script>
		<script src="geolet.js"></script>
  </head>
	<body>
		<div id="map"></div>
	 <button type="button" id='reset' onclick="mapoff()">Reset View</button>
    <script>
			var startLoc = [43.7, -79.4];
			var map = L.map('map').setView(startLoc, 12);

			var Stamen_Toner = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}{r}.{ext}', {
				attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
				subdomains: 'abcd',
				minZoom: 0,
				maxZoom: 20,
				ext: 'png'
			});

	    map.addLayer(Stamen_Toner);

			var mainId;
			var reachIds = [];

			function getIdMatch(id){
				if (id === mainId) {
					return 'primary'
				} else {
					return 'reach'
				}
			};

			function clickFeature(e) {
			    var layer = e.target;

					matrixLayer.clearLayers();

					mainId = layer.feature.properties.id;
//					reachIds = mat[String(mainId)]
					info.update(layer.feature.properties);

					matrixLayer.addData(mat);
			}

			function onEachFeature(feature, layer) {
			    // does this feature have a property named popupContent?
					layer.on({
							click: clickFeature
					});
			}

			var homeIcon = L.icon({
			    iconUrl: 'home-base.svg',
			    iconSize:     [30,30], // size of the icon
			    iconAnchor:   [15,15] // point of the icon which will correspond to marker's location
			});

            function getColor(d) {
                return d > 30 ? '#edf8fb':
                        d > 25 ? '#ccece6':
                        d > 20 ? '#99d8c9':
                        d > 15 ? '#66c2a4':
                        d > 10 ? '#41ae76':
                        d > 5 ? '#238b45':
                                '#005824'
            };

            function gradientStyle(feature){
                return{
                    radius: 8,
										fillColor: getColor(feature.properties['travel_time_p50']),
										color: '#005824',
										weight: 2,
										opacity: 1,
										fillOpacity: 0.8
                }
            };

			function style(t, feature, latlng) {

				if (t === 'primary'){
					return L.marker(latlng, {icon: homeIcon});
				} else if (t === 'reach'){
					return L.circleMarker(latlng, gradientStyle(feature));
				} else {
				}
			};

			var baseMarkerOptions = {
				radius: 8,
				fillColor: '#969696',
				color: '#252525',
				weight: 2,
				opacity: 1,
				fillOpacity: 0.5
			}

			function pointFunction(feature, latlng) {
					var idx = feature.properties.id;
					var type = getIdMatch(idx);
					return style(type, feature, latlng)
			};

			var info = L.control();

			info.onAdd = function (map) {
			    this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
			    this.update();
			    return this._div;
			};

			// method that we will use to update the control based on feature properties passed
			info.update = function (props) {
			    this._div.innerHTML = '<h4>Brewery Details</h4>' +  (props ?
			        '<img src="home-base.svg" height="15" width = "15"/>\t<a href=' + props.web + '><b>' + props.name + '</b></a><br />' +
									props.addr + '</b><br />' +
									props.phone
			        : 'Select a Brewery');
			};

			info.addTo(map);

			var brewLayer = L.geoJSON(brew, {
				onEachFeature: onEachFeature,
				pointToLayer: function (feature, latlng){
                    return L.circleMarker(latlng, baseMarkerOptions)
                },
			}).addTo(map);

            var matrixLayer = L.geoJSON(mat, {
				onEachFeature: onEachFeature,
				pointToLayer: pointFunction,
                filter: function (feature, layer){
                    return String(feature.properties.from_id) === String(mainId)
                }
            }).addTo(map);

			function mapoff(){
				matrixLayer.clearLayers();

				mainId = null;
				reachIds = [];
				info.update();

				matrixLayer.addData(mat);
			};

			L.geolet({
				position: 'topleft'
			}).addTo(map);


    </script>
  </body>
</html>
